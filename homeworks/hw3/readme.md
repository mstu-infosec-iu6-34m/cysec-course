# Домашнее задание 3. Мини-харденинг Linux-сервера.
В рамках данного домашнего задания вам необходимо настроить удаленный доступ к Linux-серверу по ssh, 
выполняя базовые принципы безопасности, а также настроить файрволл на этом сервере. Для простоты будем использовать Docker.
В процессе выполнения задания, возможно, придется погуглить.

**Распределение баллов:**
- Безопасно настроен удаленный доступ — +50 баллов
- Настроен файрволл — +50 баллов

**Суммарно**: 100 баллов

Сдать надо будет zip-архив, содержащий:
- Лог командной строки внутри настраиваемого контейнера (в котором видно весь процесс настройки и выводы команд, если в логе помойка, то ничего страшного)
- Содержание sshd_config файла настраиваемого контейнера
- Результаты сканирования nmap до и после настройки файрволла (должно быть видно, что до настройки открыты порты 80 и 22, а после только 22)

[Ссылка для сдачи](https://example.com)

## Инструкция (если будут проблемы в процессе, пишите в чат канала курса)
1. Устанавливаем [Docker Desktop](https://www.docker.com/products/docker-desktop/). На винде надо сначала включить WSL 2.
2. Скачиваем и запускаем два образа ([kali](https://hub.docker.com/r/kalilinux/kali-rolling) и [web-dvwa](https://hub.docker.com/r/vulnerables/web-dvwa))
   ```
   sudo docker pull kalilinux/kali-rolling
   sudo docker run -d -t --name kali kalilinux/kali-rolling
   sudo docker exec -it kali bash
   ```
   ```
   sudo docker run --cap-add=NET_ADMIN --rm -it -p 80:80 vulnerables/web-dvwa
   ``` 
3. Теперь объединяем два контейнера в общую виртуальную сеть
   ```
   sudo docker network create my-network //создаем сеть
   docker ps //смотрим список контейнеров
   docker network connect my-network reverent_varahamihira //здесь указываем свои имена контейнеров вместо этих
   docker network connect my-network kali 
   ```
4. Немного допиливаем kali, потому что изначально в контейнере почти нет инструментов (следующие команды выполняем внутри терминала контейнера,
   туда можно попасть через свой терминал, как в начале инструкции, или можно через GUI докера и написать `/bin/bash`). Недостающие тулзы потом по аналогии устанавливаем.
   ```
   apt update && apt -y install net-tools ssh nmap
   ```
5. Теперь будем немного дорабатывать контейнер dvwa. Сначала надо актуализировать sources.list, чтобы apt нормально работал. Для этого через GUI докера
   открываем файлы контейнера dvwa, находим там /etc/apt/sources.list, заменяем содержимое на (я взял [отсюда](https://debiansupport.com/mirrors/) для debian 9):
   ```
   deb http://archive.debian.org/debian/ stretch main contrib non-free
   deb http://archive.debian.org/debian/ stretch-proposed-updates main contrib non-free
   deb http://archive.debian.org/debian-security stretch/updates main contrib non-free
   ```
6. Подключаемся через GUI докера к терминалу dvwa (exec), там пишем `/bin/bash`, потом устанавливаем и запускаем ssh:
   ```
   apt update
   apt install ssh
   /etc/init.d/ssh start
   ```
7. Можно установить текстовый редактор, например `apt install nano`
8. При помощи команды `ip a` смотрим внутри контейнера dvwa свой ip-адрес для адаптера eth1. Например, в моем случае это 172.18.0.2:
   ```
   22: eth1@if23: <BROADCAST,MULTICAST,UP,LOWER_UP> mtu 1500 qdisc noqueue state UP group default 
       link/ether 02:42:ac:12:00:02 brd ff:ff:ff:ff:ff:ff link-netnsid 0
       inet 172.18.0.2/16 brd 172.18.255.255 scope global eth1
         valid_lft forever preferred_lft forever
   ```
9. Сканируем через контейнер с kali через nmap `nmap -sV -sS -O <ip адрес>`. Должны быть открыты порты 22 и 80. Вывод можете скопировать прямо из терминала, можно в nmap использовать аргумент `-oN <имя файла>`, тогда вывод сохранится сразу в файл
10. Внутри контейнера dvwa создаем пользователя со своим именем, делаем его администратором
11. Пробуем через kali подключиться по ssh от имени этого пользователя `ssh <имя>@<ip>`
12. На kali при помощи ssh-keygen и ssh-copy-id генерируем ssh-ключ и настраиваем вход по нему в контейнер dvwa
13. Проверяем, что получилось подключиться ко второму контейнеру с использованием ssh-ключа (не потребуется ввод пароля пользователя, которого создали)
14. При помощи изменений в sshd_config: отключаем удаленный вход по паролю, отключаем удаленный вход root, перезапускаем ssh
    ```
    /etc/init.d/ssh stop
    /etc/init.d/ssh start
    ```
16. Проверяем, что все еще можно удаленно подключиться по ssh
17. Настраиваем файрволл, чтобы закрыть снаружи подключение к порту 80 (придется погуглить, с ufw проще настроить)
18. После настройки и включения файрволла снова сканируем nmap-ом контейнер и проверяем, что открыт только порт 22
